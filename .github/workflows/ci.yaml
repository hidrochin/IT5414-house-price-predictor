name: CI Pipeline

on:
  push:
    branches: [main, feature/*]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  API_IMAGE_NAME: ${{ github.repository }}/house-price-api
  UI_IMAGE_NAME: ${{ github.repository }}/house-price-ui

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install linting tools
        run: |
          pip install flake8 black
          
      - name: Run flake8
        run: flake8 src/ --max-line-length=120 --ignore=E501,W503
        
      - name: Check black formatting
        run: black --check src/ --line-length=120
        continue-on-error: true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov httpx
          
      - name: Create test model files
        run: |
          mkdir -p models/trained
          # Create minimal pickle files for testing
          python -c "
          import joblib
          from sklearn.ensemble import GradientBoostingRegressor
          from sklearn.compose import ColumnTransformer
          from sklearn.preprocessing import OneHotEncoder
          from sklearn.pipeline import Pipeline
          from sklearn.impute import SimpleImputer
          import numpy as np
          import pandas as pd
          
          # Define features (must match inference.py)
          numerical_features = ['sqft', 'bedrooms', 'bathrooms', 'house_age', 'price_per_sqft', 'bed_bath_ratio']
          categorical_features = ['location', 'condition']
          
          # Create preprocessor
          numerical_transformer = Pipeline(steps=[
              ('imputer', SimpleImputer(strategy='mean'))
          ])
          
          categorical_transformer = Pipeline(steps=[
              ('onehot', OneHotEncoder(handle_unknown='ignore'))
          ])
          
          preprocessor = ColumnTransformer(
              transformers=[
                  ('num', numerical_transformer, numerical_features),
                  ('cat', categorical_transformer, categorical_features)
              ]
          )
          
          # Create dummy training data
          dummy_df = pd.DataFrame({
              'sqft': [1000, 2000, 1500, 3000, 2500],
              'bedrooms': [2, 3, 3, 4, 3],
              'bathrooms': [1, 2, 2, 3, 2],
              'house_age': [10, 20, 15, 5, 25],
              'price_per_sqft': [100, 150, 120, 200, 130],
              'bed_bath_ratio': [2, 1.5, 1.5, 1.33, 1.5],
              'location': ['urban', 'suburban', 'rural', 'urban', 'suburban'],
              'condition': ['Good', 'Excellent', 'Fair', 'Good', 'Excellent']
          })
          y_dummy = np.array([200000, 350000, 280000, 450000, 380000])
          
          # Fit preprocessor and transform
          X_transformed = preprocessor.fit_transform(dummy_df)
          print(f'Transformed features shape: {X_transformed.shape}')
          
          # Train model on transformed features
          model = GradientBoostingRegressor(n_estimators=10, random_state=42)
          model.fit(X_transformed, y_dummy)
          
          # Save model and preprocessor
          joblib.dump(model, 'models/trained/house_price_model.pkl')
          joblib.dump(preprocessor, 'models/trained/preprocessor.pkl')
          print('Created test model files successfully')
          "
          
      - name: Run tests with coverage
        run: |
          cd src/api && pytest ../../tests/ -v --cov=. --cov-report=xml
          
      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          file: ./src/api/coverage.xml
          fail_ci_if_error: false

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Create production model files
        run: |
          mkdir -p models/trained
          # Create production-ready model files for Docker build
          pip install joblib scikit-learn pandas numpy
          python -c "
          import joblib
          from sklearn.ensemble import GradientBoostingRegressor
          from sklearn.compose import ColumnTransformer
          from sklearn.preprocessing import OneHotEncoder
          from sklearn.pipeline import Pipeline
          from sklearn.impute import SimpleImputer
          import numpy as np
          import pandas as pd
          
          # Define features (must match inference.py)
          numerical_features = ['sqft', 'bedrooms', 'bathrooms', 'house_age', 'price_per_sqft', 'bed_bath_ratio']
          categorical_features = ['location', 'condition']
          
          # Create preprocessor
          preprocessor = ColumnTransformer(
              transformers=[
                  ('num', Pipeline([('imputer', SimpleImputer(strategy='mean'))]), numerical_features),
                  ('cat', Pipeline([('onehot', OneHotEncoder(handle_unknown='ignore'))]), categorical_features)
              ]
          )
          
          # Create training data with all categorical values
          dummy_df = pd.DataFrame({
              'sqft': [1000, 2000, 3000, 1500, 2500],
              'bedrooms': [2, 3, 4, 3, 3],
              'bathrooms': [1, 2, 3, 2, 2],
              'house_age': [10, 20, 5, 15, 25],
              'price_per_sqft': [100, 150, 200, 120, 140],
              'bed_bath_ratio': [2, 1.5, 1.33, 1.5, 1.5],
              'location': ['urban', 'suburban', 'rural', 'urban', 'suburban'],
              'condition': ['Good', 'Excellent', 'Fair', 'Good', 'Excellent']
          })
          y_dummy = np.array([200000, 350000, 450000, 280000, 380000])
          
          # Fit preprocessor and transform
          X_transformed = preprocessor.fit_transform(dummy_df)
          print(f'Transformed features shape: {X_transformed.shape}')
          
          # Create and train model on transformed features
          model = GradientBoostingRegressor(
              n_estimators=300,
              learning_rate=0.1,
              max_depth=3,
              random_state=42
          )
          model.fit(X_transformed, y_dummy)
          
          # Save model and preprocessor
          joblib.dump(model, 'models/trained/house_price_model.pkl')
          joblib.dump(preprocessor, 'models/trained/preprocessor.pkl')
          print('Created production model files')
          "
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata for API
        id: meta-api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.API_IMAGE_NAME }}
          tags: |
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
            
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-api.outputs.tags }}
          labels: ${{ steps.meta-api.outputs.labels }}
          
      - name: Extract metadata for UI
        id: meta-ui
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.UI_IMAGE_NAME }}
          tags: |
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
            
      - name: Build and push UI image
        uses: docker/build-push-action@v5
        with:
          context: ./streamlit_app
          file: ./streamlit_app/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-ui.outputs.tags }}
          labels: ${{ steps.meta-ui.outputs.labels }}
